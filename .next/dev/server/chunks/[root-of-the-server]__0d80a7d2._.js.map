{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/USER/Downloads/aicareermentor/app/api/submit-quiz/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\n\nexport const runtime = \"nodejs\"\n\n// Helper function to call Ollama API (open-source AI)\nasync function callOllama(prompt: string): Promise<string> {\n  const ollamaUrl = process.env.OLLAMA_URL || \"http://localhost:11434\"\n  const model = process.env.OLLAMA_MODEL || \"llama3.2\" // Default to llama3.2, can be changed to mistral, qwen, etc.\n\n  try {\n    const response = await fetch(`${ollamaUrl}/api/generate`, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify({\n        model: model,\n        prompt: prompt,\n        stream: false,\n        options: {\n          temperature: 0.7,\n          num_predict: 2000,\n        },\n      }),\n    })\n\n    if (!response.ok) {\n      throw new Error(`Ollama API error: ${response.statusText}`)\n    }\n\n    const data = await response.json()\n    return data.response || \"\"\n  } catch (error) {\n    console.error(\"[v0] Ollama API error:\", error)\n    // Fallback: Try using Hugging Face Inference API as alternative open-source option\n    try {\n      return await callHuggingFace(prompt)\n    } catch (hfError) {\n      console.error(\"[v0] Both Ollama and Hugging Face failed:\", hfError)\n      throw new Error(\n        \"Open-source AI service unavailable. Please ensure Ollama is running (http://localhost:11434) or configure Hugging Face API key.\"\n      )\n    }\n  }\n}\n\n// Fallback: Hugging Face Inference API (open-source alternative)\nasync function callHuggingFace(prompt: string): Promise<string> {\n  const hfModel = process.env.HUGGINGFACE_MODEL || \"mistralai/Mistral-7B-Instruct-v0.2\"\n  const hfApiKey = process.env.HUGGINGFACE_API_KEY\n\n  if (!hfApiKey) {\n    throw new Error(\"No open-source AI service configured. Please set up Ollama or Hugging Face API key.\")\n  }\n\n  try {\n    const response = await fetch(`https://api-inference.huggingface.co/models/${hfModel}`, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        Authorization: `Bearer ${hfApiKey}`,\n      },\n      body: JSON.stringify({\n        inputs: prompt,\n        parameters: {\n          temperature: 0.7,\n          max_new_tokens: 2000,\n        },\n      }),\n    })\n\n    if (!response.ok) {\n      throw new Error(`Hugging Face API error: ${response.statusText}`)\n    }\n\n    const data = await response.json()\n    if (Array.isArray(data) && data[0]?.generated_text) {\n      return data[0].generated_text\n    }\n    return JSON.stringify(data)\n  } catch (error) {\n    console.error(\"[v0] Hugging Face API error:\", error)\n    throw error\n  }\n}\n\nexport async function POST(req: Request) {\n  try {\n    const body = await req.json()\n    const { quizAnswers, userId, userEmail } = body || {}\n\n    if (!quizAnswers || Object.keys(quizAnswers).length === 0) {\n      return NextResponse.json({ error: \"Please complete the quiz first.\", aiResult: \"\" }, { status: 400 })\n    }\n\n    // Validate that we have at least some answers\n    const answerCount = Object.keys(quizAnswers).filter(key => quizAnswers[key] !== undefined && quizAnswers[key] !== null).length\n    if (answerCount === 0) {\n      return NextResponse.json({ error: \"No valid answers provided.\", aiResult: \"\" }, { status: 400 })\n    }\n\n    // Format quiz answers for the AI prompt\n    const quizQuestions = [\n      \"What type of work environment do you prefer?\",\n      \"Which skill area interests you most?\",\n      \"What is your primary career goal?\",\n      \"How do you prefer to learn?\",\n      \"What level of responsibility do you want?\",\n    ]\n\n    const formattedAnswers = Object.entries(quizAnswers)\n      .map(([key, value]) => {\n        const questionIndex = Number.parseInt(key)\n        const question = quizQuestions[questionIndex] || `Question ${questionIndex + 1}`\n        return `${question}\\nAnswer: ${value}`\n      })\n      .join(\"\\n\\n\")\n\n    const systemPrompt = `Tu es un assistant AI de carrière expert en informatique et ingénierie.\nAnalyse les réponses du quiz de l'utilisateur et fournis des recommandations de carrière détaillées.\n\nFormat de sortie EXACT (JSON valide):\n{\n  \"career_path\": \"Description claire du chemin de carrière recommandé basé sur les réponses (travail individuel, en groupe, en entreprise, freelance...)\",\n  \"job_offers\": [\"Liste de 5-8 postes ou opportunités spécifiques adaptées (PFE, stages, CDI) en Tunisie et Europe\"],\n  \"resources\": [\"Liste de 5-10 sites et ressources pour trouver ces opportunités (LinkedIn, GitHub Jobs, sites d'emploi tunisiens, sites européens)\"]\n}\n\nSois spécifique, pratique et adapté au marché du travail tunisien et européen.`\n\n    const userPrompt = `Réponses du quiz de l'utilisateur:\n${formattedAnswers}\n\nGénère mes recommandations de carrière personnalisées en JSON valide basé sur ces réponses.`\n\n    const fullPrompt = `${systemPrompt}\\n\\n${userPrompt}`\n\n    // Call open-source AI (Ollama or Hugging Face)\n    const content = await callOllama(fullPrompt)\n\n    // Clean and format the AI response\n    let aiResult = content.trim()\n    \n    // Check if response is empty\n    if (!aiResult || aiResult.length === 0) {\n      throw new Error(\"AI service returned an empty response. Please try again.\")\n    }\n    \n    // Try to extract JSON if the response contains JSON\n    try {\n      // Look for JSON in the response (might be wrapped in markdown code blocks)\n      const jsonMatch = aiResult.match(/```(?:json)?\\s*(\\{[\\s\\S]*\\})\\s*```/) || aiResult.match(/(\\{[\\s\\S]*\\})/)\n      if (jsonMatch) {\n        const parsed = JSON.parse(jsonMatch[1])\n        aiResult = JSON.stringify(parsed, null, 2)\n      } else {\n        // Try parsing the entire response as JSON\n        const parsed = JSON.parse(aiResult)\n        aiResult = JSON.stringify(parsed, null, 2)\n      }\n    } catch (e) {\n      // If not JSON, return as formatted text\n      console.log(\"[v0] Response is not JSON, returning as text\")\n      // Format the text response nicely - keep the original content\n      aiResult = aiResult\n    }\n\n    if (userId) {\n      try {\n        // Use Supabase server client with proper authentication\n        const { createClient } = await import(\"@/lib/supabase/server\")\n        const supabase = await createClient()\n\n        const { error: dbError } = await supabase.from(\"quiz_results\").insert([\n          {\n            user_id: userId,\n            quiz_answers: quizAnswers,\n            ai_result: aiResult,\n          },\n        ])\n\n        if (dbError) {\n          console.error(\"[v0] Database save error:\", dbError)\n          // Don't fail the request if DB save fails, AI result is already generated\n        }\n      } catch (dbError) {\n        console.error(\"[v0] Database save error:\", dbError)\n        // Don't fail the request if DB save fails\n      }\n    }\n\n    return NextResponse.json({ aiResult })\n  } catch (err) {\n    console.error(\"[v0] Quiz submit error:\", err)\n    const errorMessage = err instanceof Error ? err.message : \"Server error\"\n    return NextResponse.json(\n      {\n        error: errorMessage,\n        aiResult: errorMessage.includes(\"Open-source AI service unavailable\")\n          ? \"Please configure Ollama or Hugging Face to generate AI recommendations. See setup instructions in the README.\"\n          : \"Unable to generate recommendations. Please try again.\",\n      },\n      { status: 500 },\n    )\n  }\n}\n"],"names":[],"mappings":"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"}}]
}